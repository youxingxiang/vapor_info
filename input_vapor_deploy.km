{"root":{"data":{"id":"99a0eb54dd93","created":1611105730,"text":"输入 vapor deploy","expandState":"expand"},"children":[{"data":{"id":"c8nlcpp979s0","created":1611105832255,"text":"检测用户是否登陆 ","expandState":"expand","layout":null,"note":"检测 `$_SERVER['HOME'].'/.laravel-vapor/config.json' ` \n存储的登陆 token 是否存在"},"children":[{"data":{"id":"c8nlfh9z79s0","created":1611106049010,"text":"向 vapor 后台验证 vapor.yml 信息","layout":null,"expandState":"expand"},"children":[{"data":{"id":"c8nryjsc5ww0","created":1611124470052,"text":"打包文件并上传","note":null,"layout":null,"expandState":"expand"},"children":[{"data":{"id":"c8ns7gm92200","created":1611125168431,"text":" 获取在平台注册的项目信息","layout":null,"expandState":"expand","note":"`\narray:19 [\n  \"id\" => 17371\n  \"team_id\" => 23825\n  \"cloud_provider_id\" => 5887\n  \"name\" => \"laravel-admin-serverless\"\n  \"region\" => \"ap-east-1\"\n  \"bucket\" => \"vapor-ap-east-1-1611040995\"\n  \"asset_bucket\" => \"vapor-ap-east-1-assets-1611040995\"\n  \"container_repository\" => null\n  \"cloudfront_id\" => \"E1H2EO31P1EX00\"\n  \"cloudfront_domain\" => \"d2klwnyjdxm4t0.cloudfront.net\"\n  \"cloudfront_status\" => \"pending\"\n  \"github_repository\" => null\n  \"queued_for_deletion\" => false\n  \"created_at\" => \"2021-01-19T07:23:15+0000\"\n  \"updated_at\" => \"2021-01-19T07:23:21+0000\"\n  \"team\" => array:6 [\n    \"id\" => 23825\n    \"user_id\" => 19262\n    \"name\" => \"dcat\"\n    \"personal_team\" => false\n    \"created_at\" => \"2021-01-14T07:29:36+0000\"\n    \"updated_at\" => \"2021-01-14T07:29:36+0000\"\n  ]\n  \"cloud_provider\" => array:13 [\n    \"id\" => 5887\n    \"team_id\" => 23825\n    \"uuid\" => \"906dbcad-3220-475a-bf33-8ae10689cebd\"\n    \"name\" => \"developer\"\n    \"type\" => \"AWS\"\n    \"role_arn\" => \"arn:aws:iam::497311179103:role/laravel-vapor-role\"\n    \"role_sync\" => true\n    \"sns_topic_arn\" => null\n    \"network_limit\" => 5\n    \"last_deleted_rest_api_at\" => \"2021-01-19T01:57:46+0000\"\n    \"queued_for_deletion\" => false\n    \"created_at\" => \"2021-01-14T07:31:57+0000\"\n    \"updated_at\" => \"2021-01-19T01:57:46+0000\"\n  ]\n  \"asset_domains\" => array:2 [\n    \"cloudfront\" => null\n    \"s3\" => \"https://vapor-ap-east-1-assets-1611040995.s3.ap-east-1.amazonaws.com\"\n  ]\n  \"last_deployed_at\" => null\n]\n\n`","priority":1},"children":[]},{"data":{"id":"c8ns7hgey1s0","created":1611125170255,"text":" 执行 vapor build 命令","layout":null,"expandState":"expand","note":null,"priority":2},"children":[{"data":{"id":"c8nsfpmjjg00","created":1611125814953,"text":"检测用户是否登陆","priority":1,"expandState":"expand"},"children":[]},{"data":{"id":"c8nsfqlq3ds0","created":1611125817080,"text":"检测是否要使用 `docker`","priority":2,"expandState":"expand"},"children":[]},{"data":{"id":"c8nsfrl0ul40","created":1611125819215,"text":"将应用程序复制到构建路径","priority":3,"note":"`Laravel\\VaporCli\\BuildProcess\\CopyApplicationToBuildPath`","expandState":"expand"},"children":[{"data":{"id":"c8nsis70vj40","created":1611126055638,"text":"格式化构建目录","priority":1,"note":"临时打包地址`/Users/youxingxiang/Code/laravel-admin-serverless/.vapor/build`","expandState":"expand"},"children":[]},{"data":{"id":"c8nsitexztk0","created":1611126058293,"text":"将代码移动到构建目录","priority":2,"note":"逻辑处理代码在\n`\nLaravel\\VaporCli\\ApplicationFiles\n`","expandState":"expand"},"children":[]},{"data":{"id":"c8nsiuavsvk0","created":1611126060224,"text":"清除构建代码中缓存的配置文件","priority":3,"expandState":"expand"},"children":[]},{"data":{"id":"c8nsiv6pgao0","created":1611126062149,"text":"清除构建代码中 storage 目录的文件","priority":4,"expandState":"expand"},"children":[]}]},{"data":{"id":"c8nsfsggi0w0","created":1611125821116,"text":"协调配置文件","priority":4,"note":"`Laravel\\VaporCli\\BuildProcess\\HarmonizeConfigurationFiles`\n`AWS_ACCESS_KEY_ID` 替换为 `NULL_AWS_ACCESS_KEY_ID`","expandState":"expand"},"children":[]},{"data":{"id":"c8nsft6irrs0","created":1611125822691,"text":"设置构建环境","priority":5,"note":"* 拷贝 .env 文件\n* 设置 APP_ENV\n* 设置 ASSET_URL","expandState":"expand"},"children":[]},{"data":{"id":"c8ntbsmt97c0","created":1611128329153,"text":"执行构建命令","priority":6,"note":"在构建目录运行 `php artisan event:cache` ","expandState":"expand"},"children":[]},{"data":{"id":"c8ntfzu4c0w0","created":1611128658289,"text":"artisan 配置文件修改","priority":7,"note":"```php\n$app->useStoragePath(Laravel\\Vapor\\Runtime\\StorageDirectories::PATH)\n```","expandState":"expand"},"children":[]},{"data":{"id":"c8ntjw3rwqg0","created":1611128963622,"text":"配置Composer自动加载器","priority":8,"note":"```\nvendor 目录 __DIR__ . /../.. 换为\n/var/task\n ```","expandState":"expand"},"children":[]},{"data":{"id":"c8ntrfol8dc0","created":1611129554789,"text":"移除一些不必要的文件","priority":9,"note":"* 删除项目目录下忽略的文件\n* 删除 `resources` `vendor` `storage` 目录下不必要的资源文件\n* 删除 `Symfony` 测试文件\n* 删除 `vapor.yml` 的 \t`ignore` 忽略文件","expandState":"expand"},"children":[]},{"data":{"id":"c8ntxqufwp40","created":1611130049272,"text":"10  移除 platform_check 的内容","priority":null,"note":"```\nif ($this->files->exists($path = Path::app().'/vendor/composer/platform_check.php')) {\n            $this->files->put($path, '<?php'.PHP_EOL);\n        }\n```","expandState":"expand"},"children":[]},{"data":{"id":"c8ntyzawc5k0","created":1611130146046,"text":"11 public 下面的 css 本地路径替换为 cdn  ","expandState":"expand"},"children":[]},{"data":{"id":"c8nu8rm7zgw0","created":1611130912958,"text":"12 删除构建项目的 public 的资源文件放到 assets 目录","expandState":"expand"},"children":[]},{"data":{"id":"c8nuh19hw9k0","created":1611131560870,"text":"13 注入 serverless 处理函数文件","note":"```\n     $this->files->copy($stubPath.'/cliRuntime.php', $this->appPath.'/cliRuntime.php');\n        $this->files->copy($stubPath.'/fpmRuntime.php', $this->appPath.'/fpmRuntime.php');\n        $this->files->copy($stubPath.'/httpRuntime.php', $this->appPath.'/httpRuntime.php');\n        $this->files->copy($stubPath.'/httpHandler.php', $this->appPath.'/httpHandler.php');\n```","expandState":"expand"},"children":[]},{"data":{"id":"c8nuk7vf18g0","created":1611131810348,"text":"14 收集后台设置的 Secrets  保存到 vaporSecrets.php 文件","expandState":"expand"},"children":[]},{"data":{"id":"c8num1sby7k0","created":1611131953829,"text":"15 注入 503 错误页面","expandState":"expand"},"children":[]},{"data":{"id":"c8nuni2k76o0","created":1611132067641,"text":"16 注入 rds 证书","expandState":"expand"},"children":[]},{"data":{"id":"c8nuoxrn70o0","created":1611132180173,"text":"17 将vendor 目录移动到项目外的构建目录 vendor","expandState":"expand"},"children":[]},{"data":{"id":"c8nuq6iq2pk0","created":1611132277589,"text":"18 压缩构建项目","expandState":"expand"},"children":[]},{"data":{"id":"c8nurt4qwww0","created":1611132405174,"text":"19 压缩vendor 目录","expandState":"expand"},"children":[]}]},{"data":{"id":"c8ns7i67stk0","created":1611125171815,"text":"上传部署文件到 aws","layout":null,"expandState":"expand","priority":3},"children":[{"data":{"id":"c8nvkw5nqf40","created":1611134684320,"text":"将部署代码的信息上传到 vapor 平台","priority":1,"expandState":"expand"},"children":[]},{"data":{"id":"c8nvkwzf2hs0","created":1611134686120,"text":"代码部署到 aws","priority":2,"expandState":"expand"},"children":[]},{"data":{"id":"c8nvkxoocmw0","created":1611134687647,"text":"部署aws 成功上传信息到 vapor 平台","priority":3,"expandState":"expand"},"children":[]}]},{"data":{"id":"c8ns7iz1y1c0","created":1611125173559,"text":"静态资源文件上传到 aws","layout_right_offset":{"x":4,"y":4},"layout":null,"expandState":"expand","priority":4},"children":[]}]}]}]}]},"template":"right","theme":"fresh-blue","version":"1.4.43"}